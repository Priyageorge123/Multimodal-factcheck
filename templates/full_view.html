<!DOCTYPE html>
<html>
<head>
  <title>{{ article_id }}</title>
  <style>
    .tag { display:inline-block; margin:4px; padding:4px 10px;
           border-radius:4px; color:white; font-weight:bold;
           cursor:pointer; }
    .toggle-container { margin-top:20px; }
    .toggle-btn {
      padding:8px 16px; margin-right:10px;
      cursor:pointer; border:none; background:#ddd;
      font-weight:bold; border-radius:4px;
    }
    .toggle-btn.active { background:#4CAF50; color:white; }
    .section { margin-top:20px; }
    .images-grid {
      display:flex; flex-wrap:wrap; gap:10px;
    }
    .images-grid div {
      border:1px solid #ccc; padding:6px;
    }
    .images-grid img {
      max-width:200px; display:block;
    }
    .event-item {
      margin-bottom:10px;
      border:1px solid #ccc;
      border-radius:4px;
      overflow:hidden;
    }
    .event-header {
    margin: 0;
    padding: 8px 12px;
    background: white;           /* plain white */
    border-left: 6px solid;      /* we’ll set the color inline */
    color: inherit;              /* inline color will override */
    cursor: pointer;
    font-size: 1.1em;
    }

    .event-details {
      display:none;
      padding:10px;
      background:#f9f9f9;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-bottom:10px;
    }
    table, th, td {
      border:1px solid #aaa;
    }
    th, td {
      padding:6px;
      text-align:left;
    }
    .viewer-box {
      margin:8px 0;
      padding:8px;
      border:1px solid #ccc;
      background:white;
    }
  </style>
</head>
<body>
  <h1>Article: {{ article_id }}</h1>

  <!-- Main toggles -->
  <div class="toggle-container">
    <button id="nerBtn"  class="toggle-btn active"
            onclick="toggleSection('nerBtn','ner')">NER</button>
    <button id="depBtn"  class="toggle-btn"
            onclick="toggleSection('depBtn','dep')">Dependency</button>
    <button id="eventBtn"class="toggle-btn"
            onclick="toggleSection('eventBtn','events')">Events</button>
  </div>

  <!-- NER section -->
  <div id="ner" class="section" style="display:block;">
    <div>
      {% for label in entity_map %}
        <span class="tag" style="background-color:{{ color_map[label] }}">
          {{ label }}
        </span>
      {% endfor %}
    </div>
    {{ ner_html|safe }}
  </div>

  <!-- Dependency section -->
  <div id="dep" class="section" style="display:none;">
    {% for dep_html, labels in zipped_deps %}
      <div style="margin-bottom:30px;">
        <div style="margin-bottom:5px;">
          {% for lab in labels %}
            <span class="tag" style="background:#ddd; color:black;">
              {{ lab }}
            </span>
          {% endfor %}
        </div>
        <div>{{ dep_html|safe }}</div>
      </div>
    {% endfor %}
  </div>


<!-- EVENTS -->
    <div id="events" class="section" style="display:none;">

    <!-- Associated Images -->
    {% if image_filenames %}
        <div style="border:2px solid #aaa; padding:10px; margin-bottom:20px;">
        <h3>Associated Images</h3>
        <div class="images-grid">
            {% for img in image_filenames %}
            <div>
                <img src="{{ url_for('static', filename=img) }}" style="max-width:200px; display:block;">
                <div style="text-align:center;">{{ img.split('/')[-1] }}</div>
            </div>
            {% endfor %}
        </div>
        </div>
    {% endif %}

    <!-- All event‐type headers -->
    <div>
        {% for et in event_types %}
        {% set safe = et.replace(':','_').replace(' ','_') %}
        <div class="event-item">
            <h3 class="event-header"
                style="
                border-left-color: {{ event_type_colors.get(et,'#888') }};
                color: {{ event_type_colors.get(et,'#888') }};
                "
                onclick="toggleEventType('{{ safe }}')">
            {{ et }}
            </h3>

            <div id="{{ safe }}" class="event-details">
            {% if events.get(et) %}
                <table>
                <tr><th>Sentence ID</th><th>Trigger</th><th>Arguments</th></tr>
                {% for e in events[et] %}
                    <tr>
                    <td>{{ e.sentence_id }}</td>
                    <td>{{ e.trigger }}</td>
                    <td>
                        {% for a in e.arguments %}
                        <strong>{{ a.role }}</strong>: {{ a.text }}<br>
                        {% endfor %}
                    </td>
                    </tr>
                {% endfor %}
                </table>

                <div>
                <strong>Sentences:</strong>
                <div id="viewer_{{ safe }}" class="viewer-box">
                    {{ sentence_event_map.get(et, [{'text':'No instances in this article.'}])[0].text }}
                </div>
                {% if sentence_event_map.get(et) %}
                    <button onclick="nextSentence('{{ safe }}')">Next</button>
                {% endif %}
                </div>
            {% else %}
                <p><em>No instances of this event type in this article.</em></p>
            {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    </div>


  <script>
    function toggleSection(btnId, secId) {
      document.querySelectorAll('.toggle-btn')
              .forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.section')
              .forEach(s => s.style.display = 'none');
      document.getElementById(btnId).classList.add('active');
      document.getElementById(secId).style.display = 'block';
    }

    function toggleEventType(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    const sentenceMap = {{ sentence_event_map|tojson }};
    let viewerState = {};
    function nextSentence(safe) {
      const raw = Object.keys(sentenceMap)
                        .find(t => t.replace(/[: ]/g,'_') === safe);
      if (!raw) return;
      const arr = sentenceMap[raw];
      viewerState[safe] = ((viewerState[safe] || 0) + 1) % arr.length;
      document.getElementById(`viewer_${safe}`).innerText =
        arr[viewerState[safe]].text;
    }
  </script>
</body>
</html>
